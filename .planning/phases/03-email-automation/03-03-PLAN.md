---
phase: 03-email-automation
plan: "03"
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - webhook/netlify/functions/ls-webhook.js
  - webhook/netlify.toml
autonomous: false
user_setup:
  - service: netlify
    why: "Host the serverless webhook receiver (GitHub Pages cannot serve POST endpoints)"
    env_vars:
      - name: LEMONSQUEEZY_WEBHOOK_SECRET
        source: "Lemon Squeezy Dashboard → Settings → Webhooks → Signing secret"
      - name: KIT_API_SECRET
        source: "Kit Dashboard → Settings → Developer → API Secret"
      - name: KIT_TAG_ID_PURCHASED_STARTER
        source: "Kit API: GET https://api.convertkit.com/v3/tags?api_key=YOUR_KEY → find 'purchased-starter' tag ID"
      - name: KIT_TAG_ID_PURCHASED_FULL_KIT
        source: "Kit API: GET https://api.convertkit.com/v3/tags?api_key=YOUR_KEY → find 'purchased-full-kit' tag ID"
      - name: LS_PRODUCT_ID_STARTER
        source: "Lemon Squeezy Dashboard → Products → Starter Kit → Product ID (visible in URL or product details)"
      - name: LS_PRODUCT_ID_FULL_KIT
        source: "Lemon Squeezy Dashboard → Products → Full Kit → Product ID (visible in URL or product details)"
    dashboard_config:
      - task: "Create Netlify account and deploy the webhook site"
        location: "https://app.netlify.com → Sign up → Import from Git or manual deploy"
      - task: "Set environment variables in Netlify dashboard"
        location: "Netlify Dashboard → Site → Site configuration → Environment variables"
      - task: "Create webhook in Lemon Squeezy pointing to Netlify function URL"
        location: "Lemon Squeezy Dashboard → Settings → Webhooks → Create Webhook"
  - service: lemon-squeezy
    why: "Configure outgoing webhook for order_created events"
    env_vars: []
    dashboard_config:
      - task: "Create webhook endpoint pointing to the Netlify function"
        location: "Lemon Squeezy Dashboard → Settings → Webhooks"

must_haves:
  truths:
    - "A Netlify Function receives Lemon Squeezy order_created webhooks and tags buyers in Kit"
    - "Webhook signature is verified using HMAC-SHA256 before processing"
    - "Starter Kit buyers receive the 'purchased-starter' tag in Kit"
    - "Full Kit buyers receive the 'purchased-full-kit' tag in Kit"
    - "The webhook works independently of whether the buyer's browser completes the LS redirect"
    - "Lemon Squeezy dashboard has an active webhook pointing to the Netlify function URL"
  artifacts:
    - path: "webhook/netlify/functions/ls-webhook.js"
      provides: "Serverless function: LS webhook → Kit tag subscriber"
    - path: "webhook/netlify.toml"
      provides: "Netlify site configuration for the webhook project"
  key_links:
    - from: "Lemon Squeezy order_created webhook"
      to: "webhook/netlify/functions/ls-webhook.js"
      via: "HTTPS POST to Netlify Function URL"
      pattern: "x-signature header → HMAC verification → Kit API call"
    - from: "webhook/netlify/functions/ls-webhook.js"
      to: "Kit Tags API"
      via: "POST https://api.convertkit.com/v3/tags/{id}/subscribe"
      pattern: "api_secret + buyer email"
---

<objective>
Build and deploy a Netlify Function that receives Lemon Squeezy purchase webhooks and automatically tags buyers in Kit, then configure the Lemon Squeezy webhook to point at it.

Purpose: Buyer tagging is the bridge between payment and email segmentation. Without it, the business cannot distinguish leads from buyers and cannot send targeted post-purchase communication. The Lemon Squeezy native ConvertKit integration only adds buyers to a form (no tags, no product distinction), so a custom webhook receiver is required.

Output: A deployed Netlify Function that verifies LS webhook signatures, identifies the product purchased, and applies the correct buyer tag in Kit. Lemon Squeezy webhook configured and active.
</objective>

<execution_context>
@/Users/wilfredshammah/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wilfredshammah/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-email-automation/03-RESEARCH.md
@.planning/phases/03-email-automation/03-01-SUMMARY.md
@downloads/asset-manifest.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Netlify Function webhook receiver</name>
  <files>webhook/netlify/functions/ls-webhook.js, webhook/netlify.toml</files>
  <action>
Create a standalone webhook project in the `webhook/` directory at the project root. This is a separate Netlify site — it does NOT deploy to GitHub Pages.

**Create `webhook/netlify.toml`:**
```toml
[build]
  functions = "netlify/functions"

[functions]
  node_bundler = "esbuild"
```

**Create `webhook/netlify/functions/ls-webhook.js`:**

Implement the Lemon Squeezy → Kit buyer tagging webhook handler following the verified pattern from 03-RESEARCH.md:

1. **Verify webhook signature** using HMAC-SHA256:
   - Get the raw body from `event.body`
   - Get the signature from `event.headers["x-signature"]`
   - Compute HMAC using `crypto.createHmac("sha256", process.env.LEMONSQUEEZY_WEBHOOK_SECRET).update(rawBody).digest("hex")`
   - Compare using `crypto.timingSafeEqual` (constant-time comparison to prevent timing attacks)
   - CRITICAL: Verify signature BEFORE parsing JSON (raw body must match what LS signed)
   - Return 401 if signature is invalid

2. **Parse the event and check event type:**
   - Parse the raw body as JSON
   - Check `data.meta.event_name === "order_created"`
   - Return 200 "Ignored" for other event types (don't error on non-order events)

3. **Extract buyer info:**
   - `buyerEmail` from `data.data.attributes.user_email`
   - `productId` from `data.data.attributes.first_order_item.product_id`

4. **Map product ID to Kit tag ID:**
   - Use env vars: `LS_PRODUCT_ID_STARTER` → `KIT_TAG_ID_PURCHASED_STARTER`
   - Use env vars: `LS_PRODUCT_ID_FULL_KIT` → `KIT_TAG_ID_PURCHASED_FULL_KIT`
   - Convert productId to String for comparison (LS sends numbers, env vars are strings)
   - Return 200 "Unknown product" if no mapping found (don't error)

5. **Tag buyer in Kit:**
   - POST to `https://api.convertkit.com/v3/tags/${kitTagId}/subscribe`
   - Body: `{ "api_secret": process.env.KIT_API_SECRET, "email": buyerEmail }`
   - Content-Type: application/json
   - Return 500 if Kit API fails (so LS retries)
   - Return 200 "OK" on success

6. **Add CORS headers** to allow Netlify's health checks:
   - Allow methods: POST, OPTIONS
   - Handle OPTIONS preflight with 200

**IMPORTANT implementation details:**
- Use `const crypto = require("node:crypto")` (Node.js built-in, no npm install needed)
- Use global `fetch` (available in Netlify Functions Node 18+)
- All IDs and secrets come from environment variables — NOTHING hardcoded
- Log the buyer email and product for debugging (Netlify logs are private)
  </action>
  <verify>
Files exist: `webhook/netlify/functions/ls-webhook.js` and `webhook/netlify.toml`. The function file contains: crypto import, signature verification using timingSafeEqual, event_name check, product-to-tag mapping, Kit API POST call. No hardcoded secrets or IDs. The netlify.toml points functions to the correct directory.
  </verify>
  <done>
Netlify Function code is complete with HMAC signature verification, product-to-tag routing, and Kit API integration — ready for deployment.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Deploy webhook to Netlify and configure Lemon Squeezy webhook</name>
  <action>
The user must deploy the webhook function and configure both Netlify env vars and the Lemon Squeezy outgoing webhook. Claude cannot access these dashboards.

**Step-by-step instructions:**

**A. Get Required IDs and Secrets**

1. **Kit API Secret:**
   - Go to Kit Dashboard → Settings → Developer (or Account Settings → Advanced)
   - Copy the API Secret (NOT the API Key — the secret is needed for tag operations)

2. **Kit Tag IDs:**
   - Run this in your terminal (replace YOUR_API_KEY with your Kit public API key):
   ```
   curl -s "https://api.convertkit.com/v3/tags?api_key=YOUR_API_KEY" | python3 -m json.tool
   ```
   - Find the IDs for: `purchased-starter` and `purchased-full-kit`
   - Note: These are numeric IDs (e.g., 3456789)

3. **Lemon Squeezy Product IDs:**
   - Go to Lemon Squeezy Dashboard → Products
   - Click on "Starter Kit" → note the product ID from the URL or product details page
   - Click on "Full Kit" → note the product ID
   - These are numeric IDs (e.g., 123456)

**B. Deploy to Netlify**

1. Go to https://app.netlify.com and sign up / log in
2. Option A (easiest): Manual deploy
   - Create a new site → "Deploy manually"
   - Drag and drop the `webhook/` folder from your project
3. Option B: Connect a GitHub repo
   - Push the `webhook/` folder to a separate GitHub repo (or a subfolder with base directory set)
   - Import in Netlify with base directory: `webhook`

4. After deploy, note the Netlify site URL: `https://[your-site-name].netlify.app`
5. The function will be available at: `https://[your-site-name].netlify.app/.netlify/functions/ls-webhook`

**C. Set Environment Variables in Netlify**

Go to Netlify Dashboard → Site → Site configuration → Environment variables. Add:

| Variable | Value |
|----------|-------|
| LEMONSQUEEZY_WEBHOOK_SECRET | (set in step D below) |
| KIT_API_SECRET | (from step A.1) |
| KIT_TAG_ID_PURCHASED_STARTER | (from step A.2) |
| KIT_TAG_ID_PURCHASED_FULL_KIT | (from step A.2) |
| LS_PRODUCT_ID_STARTER | (from step A.3) |
| LS_PRODUCT_ID_FULL_KIT | (from step A.3) |

**D. Create Lemon Squeezy Webhook**

1. Go to Lemon Squeezy Dashboard → Settings → Webhooks
2. Click "Create Webhook" (or "+ Add Endpoint")
3. URL: `https://[your-site-name].netlify.app/.netlify/functions/ls-webhook`
4. Events: Select `order_created` only
5. Signing secret: Generate or set a strong secret, then copy it
6. Save the webhook
7. Go back to Netlify and set `LEMONSQUEEZY_WEBHOOK_SECRET` to this signing secret value
8. Redeploy the Netlify site (or trigger a redeploy) so the env var takes effect

**E. Test the webhook**

1. In Lemon Squeezy Dashboard → Settings → Webhooks → click on the webhook you created
2. Look for a "Send test" or "Test" button — send a test event
3. Check Netlify Functions logs (Netlify Dashboard → Site → Functions → ls-webhook → Logs)
4. If no test button: Use Lemon Squeezy test mode to make a test purchase
   - The `order_created` event should fire
   - Check Kit subscribers for the buyer tag

**Report these values when resuming:**
- Netlify Function URL: https://[...].netlify.app/.netlify/functions/ls-webhook
- Webhook configured in LS: yes/no
- Test result: success/failure + any error details
  </action>
  <resume-signal>Provide: Netlify Function URL, confirm webhook is configured in LS, and test result (success/failure). Example: "Function at https://contentkit-webhook.netlify.app/.netlify/functions/ls-webhook. LS webhook active. Test: 200 OK, tag applied in Kit."</resume-signal>
</task>

</tasks>

<verification>
1. webhook/netlify/functions/ls-webhook.js exists with complete implementation
2. webhook/netlify.toml exists with correct functions path
3. Netlify site is deployed and the function URL responds to POST requests
4. All 6 environment variables are set in Netlify
5. Lemon Squeezy webhook is configured and pointing to the Netlify Function URL
6. Lemon Squeezy webhook event type is set to `order_created`
7. A test purchase (or test webhook) results in the buyer tag being applied in Kit
8. The function verifies HMAC signatures and rejects invalid requests
</verification>

<success_criteria>
- The Netlify Function is deployed and the URL is live
- Lemon Squeezy dashboard has an active webhook pointing to the function
- A Lemon Squeezy order_created event results in the correct buyer tag being applied in Kit
- The webhook works independently of the buyer's browser (server-side only)
- Invalid webhook signatures are rejected with 401
</success_criteria>

<output>
After completion, create `.planning/phases/03-email-automation/03-03-SUMMARY.md`
</output>
